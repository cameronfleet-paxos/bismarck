---
phase: 03-attention-hooks
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/terminal.ts
autonomous: true

must_haves:
  truths:
    - "When provider is 'codex', a mapping file is written at terminal spawn to ~/.bismarck/sessions/codex-{hash}.json"
    - "The mapping file contains JSON with workspaceId and instanceId"
    - "The hash is SHA-256 of the agent's directory path, first 16 hex chars"
    - "Mapping file is created BEFORE the agent command is written to the PTY"
    - "Claude agents are unaffected -- no mapping file is created for Claude"
    - "TypeScript compiles with zero errors"
  artifacts:
    - path: "src/main/terminal.ts"
      provides: "CWD-based mapping file creation for Codex agents at terminal spawn"
      contains: "codex-"
  key_links:
    - from: "src/main/terminal.ts"
      to: "src/main/config.ts"
      via: "imports getConfigDir for sessions directory path"
      pattern: "getConfigDir"
    - from: "src/main/terminal.ts"
      to: "src/main/socket-server.ts"
      via: "imports getInstanceId for mapping file content"
      pattern: "getInstanceId"
---

<objective>
Add CWD-based mapping file creation to terminal.ts so the Codex notify hook script can map Codex agent turn-complete events back to the correct Bismarck workspace and instance.

Purpose: The Codex notify hook script (created in Plan 01) needs to look up workspaceId and instanceId when it receives a turn-complete event. It does this via a mapping file keyed by a hash of the agent's working directory. This plan creates that mapping file at terminal spawn time.

Output: Modified terminal.ts that writes `~/.bismarck/sessions/codex-{hash}.json` when spawning a Codex agent.
</objective>

<execution_context>
@/workspace/CLAUDE.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3/CONTEXT.md
@.planning/phases/3/03-RESEARCH.md
@src/main/terminal.ts
@src/main/config.ts
@src/main/socket-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CWD-based mapping file creation for Codex agents</name>
  <files>src/main/terminal.ts</files>
  <action>
In `src/main/terminal.ts`, add code to write a CWD-based mapping file when spawning a Codex agent. This mapping file is read by the `codex-notify-hook.sh` script (from Plan 01) to route attention events to the correct workspace.

**Step 1: Add import for getConfigDir.**

The file already imports `getWorkspaceById, saveWorkspace` from `./config`. Add `getConfigDir` to that import:

```typescript
import { getWorkspaceById, saveWorkspace, getConfigDir } from './config'
```

Note: `getInstanceId` is already imported from `./socket-server`. `crypto` is already imported. `fs` and `path` are already imported.

**Step 2: Add mapping file creation in createTerminal().**

Find the section in `createTerminal()` where the provider-specific agent command is built (the `if (provider === 'claude') { ... } else if (provider === 'codex' && !skipCommand) { ... }` block). AFTER this block and BEFORE the PTY spawn (`const ptyProcess = pty.spawn(...)`), add:

```typescript
  // Write CWD-based mapping file for Codex agents
  // The codex-notify-hook.sh uses this to route attention events to the correct workspace
  if (provider === 'codex') {
    try {
      const hash = crypto.createHash('sha256').update(cwd).digest('hex').slice(0, 16)
      const sessionsDir = path.join(getConfigDir(), 'sessions')
      fs.mkdirSync(sessionsDir, { recursive: true })
      const mappingPath = path.join(sessionsDir, `codex-${hash}.json`)
      fs.writeFileSync(mappingPath, JSON.stringify({
        workspaceId,
        instanceId: getInstanceId(),
      }))
    } catch (err) {
      devLog(`[Terminal] Failed to write Codex mapping file for workspace ${workspaceId}:`, err)
    }
  }
```

**Design decisions reflected:**
- Per CONTEXT.md: CWD-based mapping using SHA-256 hash of the directory path, first 16 hex chars
- Per CONTEXT.md: Mapping file at `~/.bismarck/sessions/codex-{hash}.json`
- Per CONTEXT.md: Contains `{workspaceId, instanceId}` — same content as Claude mapping files
- Per CONTEXT.md: Created at terminal spawn time, when we know workspaceId, instanceId, and directory
- The `sessionsDir` is created via `ensureConfigDirExists()` at startup, but we use `mkdirSync({recursive:true})` defensively
- Wrapped in try/catch so mapping file creation failure doesn't prevent terminal spawn
- Uses `cwd` (the validated directory, possibly fallen back to homedir) not `workspace.directory`

**Why before PTY spawn:** The mapping file must exist before the Codex agent starts producing events. Creating it before the PTY spawn ensures it's ready when the notify hook fires.

Do NOT modify any other part of terminal.ts. The mapping file creation is a single self-contained block.
  </action>
  <verify>
- `npx tsc --noEmit` from /workspace passes with zero errors
- `grep -n "codex-" src/main/terminal.ts` shows the mapping filename pattern
- `grep -n "createHash.*sha256" src/main/terminal.ts` shows the hash computation
- `grep -n "getConfigDir" src/main/terminal.ts` shows the import and usage
- `grep -n "codex.*mapping" src/main/terminal.ts` shows the debug log message
- `grep -c "provider === 'codex'" src/main/terminal.ts` returns at least 3 (binary detection, mapping creation, session capture on exit)
  </verify>
  <done>terminal.ts creates a CWD-based mapping file at ~/.bismarck/sessions/codex-{hash}.json when spawning a Codex agent. The file contains workspaceId and instanceId. Claude agents are unaffected. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `grep "codex-" src/main/terminal.ts` shows the mapping file name pattern in createTerminal
- [ ] `grep "createHash" src/main/terminal.ts` shows SHA-256 hash computation
- [ ] `grep "getConfigDir" src/main/terminal.ts` shows the import from config.ts
- [ ] `grep "getInstanceId" src/main/terminal.ts` shows usage in mapping file content
- [ ] `grep "workspaceId" src/main/terminal.ts` shows the mapping JSON structure
- [ ] Verify no changes to Claude agent path — `grep -B2 "codex-" src/main/terminal.ts` confirms it's inside a `provider === 'codex'` guard
</verification>

<success_criteria>
- Codex mapping file created at terminal spawn time with correct content
- Hash uses SHA-256 of cwd, first 16 hex chars
- Mapping file path is ~/.bismarck/sessions/codex-{hash}.json
- Claude agents completely unaffected (no mapping file created)
- Failure to create mapping file does not prevent terminal spawn
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/3/03-02-SUMMARY.md`
</output>
