---
phase: 02-terminal-spawning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/terminal.ts
  - src/main/terminal-queue.ts
autonomous: true

must_haves:
  truths:
    - "autoAcceptMode parameter no longer exists in any function signature or call site"
    - "Trust prompt auto-accept handler (lines 184-210) is fully deleted from terminal.ts"
    - "Accept-mode cycling handler (lines 214-250) is fully deleted from terminal.ts"
    - "TypeScript compiles with zero errors after all removals"
  artifacts:
    - path: "src/main/terminal.ts"
      provides: "createTerminal without autoAcceptMode parameter, no trust prompt handler, no accept-mode cycling"
      contains: "createTerminal"
    - path: "src/main/terminal-queue.ts"
      provides: "QueuedTerminal and queueTerminalCreation without autoAcceptMode in options"
      contains: "queueTerminalCreation"
  key_links:
    - from: "src/main/terminal-queue.ts"
      to: "src/main/terminal.ts"
      via: "spawnTerminal calls createTerminal"
      pattern: "createTerminal\\("
---

<objective>
Remove dead code from terminal.ts and terminal-queue.ts: trust prompt auto-accept, accept-mode cycling, and autoAcceptMode parameter. This is pure deletion with no provider logic -- it cleans the slate for Plan 02's provider-aware additions.

Purpose: Eliminate unreliable, dead code that clutters the terminal module before adding Codex support. Per user decision, this code "never worked reliably" and should be removed for ALL providers.

Output: Cleaned terminal.ts and terminal-queue.ts with no autoAcceptMode traces. TypeScript compiles cleanly.
</objective>

<execution_context>
@/workspace/CLAUDE.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main/terminal.ts
@src/main/terminal-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead code from terminal.ts</name>
  <files>src/main/terminal.ts</files>
  <action>
In `src/main/terminal.ts`, make these specific deletions:

1. **Remove `autoAcceptMode` parameter** from `createTerminal()` signature (line 75). The function signature should become:
   ```typescript
   export function createTerminal(
     workspaceId: string,
     mainWindow: BrowserWindow | null,
     initialPrompt?: string,
     claudeFlags?: string,
   ): string {
   ```
   (Remove trailing comma from claudeFlags if needed for clean syntax.)

2. **Remove trust prompt auto-accept handler** (lines 180-210). Delete the entire block starting from the comment `// Auto-accept workspace trust prompts for .bismarck directories` through the closing `})` of the `ptyProcess.onData` handler and the closing of the `setTimeout` callback. This includes:
   - The `trustPromptBuffer` variable declaration
   - The `trustPromptDebounce` variable declaration
   - The `trustBufferClearTimeout` variable declaration
   - The entire `ptyProcess.onData((data) => { ... })` block that handles trust prompts

3. **Remove accept-mode cycling handler** (lines 212-250). Delete the entire `if (autoAcceptMode) { ... }` block including:
   - The `acceptModeAttempts` variable
   - The `MAX_ACCEPT_MODE_ATTEMPTS` constant
   - The `acceptModeDebounce` variable
   - The `acceptModeDone` variable
   - The entire `ptyProcess.onData` handler inside the if block
   - The comment `// Auto-cycle to "accept edits on" mode for task agents`

Do NOT modify anything else. The /clear detection, shell prompt detection, Claude ready detection, PTY spawn, data forwarding, and exit handling all stay exactly as they are.
  </action>
  <verify>Run `npx tsc --noEmit` from /workspace. Zero errors expected. Then verify the dead code is gone:
- `grep -n "autoAcceptMode" src/main/terminal.ts` should return zero matches
- `grep -n "trustPrompt" src/main/terminal.ts` should return zero matches
- `grep -n "acceptMode" src/main/terminal.ts` should return zero matches
- `grep -c "ptyProcess.onData" src/main/terminal.ts` should return exactly 3 (data forwarding, /clear detection, Claude ready detection)
  </verify>
  <done>terminal.ts has no autoAcceptMode parameter, no trust prompt handler, no accept-mode cycling handler. The createTerminal function signature has 4 parameters: workspaceId, mainWindow, initialPrompt, claudeFlags.</done>
</task>

<task type="auto">
  <name>Task 2: Remove autoAcceptMode from terminal-queue.ts</name>
  <files>src/main/terminal-queue.ts</files>
  <action>
In `src/main/terminal-queue.ts`, remove `autoAcceptMode` from two locations:

1. **QueuedTerminal interface** (line 21): Remove `autoAcceptMode?: boolean` from the `options` object type. The options type becomes:
   ```typescript
   options?: {
     initialPrompt?: string
     claudeFlags?: string
   }
   ```

2. **spawnTerminal function** (line 102): Remove `item.options?.autoAcceptMode` from the `createTerminal()` call. The call becomes:
   ```typescript
   const terminalId = createTerminal(
     item.workspaceId,
     item.mainWindow,
     item.options?.initialPrompt,
     item.options?.claudeFlags,
   )
   ```
   (Remove trailing comma from claudeFlags arg if it would be a syntax issue, though trailing commas are valid in TypeScript.)

3. **queueTerminalCreation function** (line 123): Remove `autoAcceptMode?: boolean` from the `options` parameter type. The options type becomes:
   ```typescript
   options?: {
     initialPrompt?: string
     claudeFlags?: string
   }
   ```

Do NOT modify anything else in this file.
  </action>
  <verify>Run `npx tsc --noEmit` from /workspace. Zero errors expected. Then verify:
- `grep -n "autoAcceptMode" src/main/terminal-queue.ts` should return zero matches
  </verify>
  <done>terminal-queue.ts has no traces of autoAcceptMode in any interface, function parameter, or call site. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -rn "autoAcceptMode" src/` returns zero matches (fully purged from codebase)
3. `grep -rn "trustPrompt" src/main/terminal.ts` returns zero matches
4. `grep -rn "acceptMode" src/main/terminal.ts` returns zero matches
5. The createTerminal function exists and accepts exactly 4 parameters
6. The shell prompt detection handler still exists (grep for "promptDetected")
7. The /clear detection handler still exists (grep for "no content")
8. The Claude ready detection handler still exists (grep for "claudeReadyDetected")
</verification>

<success_criteria>
- All autoAcceptMode traces removed from terminal.ts and terminal-queue.ts
- Trust prompt auto-accept handler fully deleted
- Accept-mode cycling handler fully deleted
- TypeScript compiles with zero errors
- All existing functionality (shell prompt detection, /clear detection, Claude ready detection, data forwarding, exit handling) preserved unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/2/02-01-SUMMARY.md`
</output>
